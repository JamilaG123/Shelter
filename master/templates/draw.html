<p> <input id="id_shape" type="text" name="shape" value="{{ POLYGON }}">
<br> 
</p>

<html> 
<head> 
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" /> 
	<title>Google Map V3 Polygon Creator</title>
	<meta name="keywords" content="polygon,creator,google map,v3,draw,paint">
	<meta name="description" content="Google Map V3 Polygon Creator">
		
</script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvDxlP63HXGJmKLvC0t_6O_Oy1IKo6RSI&callback=initialise"
    async defer></script>	
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>

	<script type="text/javascript">
        
        var P=[];
        var myOptions;
        var map;
        var creator;
        var a;
        var PolygonPoints=[];
        var Poly;

  function initialise(){
	 myOptions = {
		  	zoom: 16,
		  	center: new google.maps.LatLng(18.505599,73.822867),
		  	mapTypeId: google.maps.MapTypeId.ROADMAP
		  }
		 map = new google.maps.Map(document.getElementById('main-map'), myOptions);
		  var creator = new PolygonCreator(map);


		 
		 
		 a=django.jQuery('#id_shape').val();

		 if(a!="") 
        {
     		var res = a.substring(20,a.length-2);

    		L= res.split(",");

    		var X="";

    		for(i=0;i <L.length;i++){
         		X+=L[i]; 
      		}

      		Y= X.split(" ");

      		var array=[];

      		for(i=0;i <Y.length;i++){
          			array.push(Y[i]);
      		}

			var result1;

			var result2;
		
			for (var i=0; i <= array.length-1 ; i ++){
			if (i%2==0){
				result1 = array[i];

			}else if (i %2 !=0){

				result2 =array[i];			
				PolygonPoints.push(new google.maps.LatLng(result2, result1));
				
			}
		}
	PolygonPoints.pop();
	console.log(PolygonPoints);
	

   Poly = new google.maps.Polygon({
                paths: PolygonPoints,
                draggable: true,
                editable: true,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35
            });

            Poly.setMap(map);
           

}
		 

}		 

$(function(){
		 $('#reset').click(function(){ 
		 		creator.destroy();
		 		creator=null;
		 		
		 		creator=new PolygonCreator(map);
		 });		 		 		 
		 //show paths
		 $('#showData').click(function(){ 
		 		$('#dataPanel').empty();
		 		if(null==creator.showData()){
		 			$('#dataPanel').append('Please first create a polygon');
		 		}else{
		 			$('#dataPanel').append(creator.showData());
                                        
		 		}
		 });
		 
		 //show color
		 $('#showColor').click(function(){ 
		 		$('#dataPanel').empty();
		 		if(null==creator.showData()){
		 			$('#dataPanel').append('Please first create a polygon');
		 		}else{
		 				$('#dataPanel').append(creator.showColor());
		 		}
		 });
	});	




	 function PolygonCreator(map){
	 	 //create pen to draw on map
		 this.map = map;
		 this.pen = new Pen(this.map);
		 var thisOjb=this;
		 this.event=google.maps.event.addListener(thisOjb.map, 'click', function(event) { 
					console.log(event.latLng);
					P.push(event.latLng); 
					thisOjb.pen.draw(event.latLng);
		 });
		 
		 this.showData = function(){
		 	return this.pen.getData();
		 }
		 
		 this.showColor = function(){
		 	return this.pen.getColor();
		 }
		 
		 //destroy the pen
		 this.destroy = function(){
		 	this.pen.deleteMis();
			if(null!=this.pen.polygon){
				this.pen.polygon.remove();
			}
			google.maps.event.removeListener(this.event);
		 }
	 }	 
	 /*
	  * pen class
	  */
	 function Pen(map){
	 	this.map= map;
	 	this.listOfDots = new Array();
		this.polyline =null;
		this.polygon = null;
		this.currentDot = null;
		//draw function
		this.draw = function(latLng){
			if (null != this.polygon) {
				alert('Click Reset to draw another');
			}else {
				if (this.currentDot != null && this.listOfDots.length > 1 && this.currentDot == this.listOfDots[0]) {
					this.drawPloygon(this.listOfDots);
				}else {
					//remove previous line
					if(null!=this.polyline){
						this.polyline.remove();
					}
					//draw Dot
					var dot = new Dot(latLng, this.map, this);
					this.listOfDots.push(dot);
					//draw line
					if(this.listOfDots.length > 1){
						this.polyline = new Line(this.listOfDots, this.map);
					}
				}
			}
		}
		//draw ploygon
		this.drawPloygon = function (listOfDots,color,des,id){
			this.polygon = new Polygon(listOfDots,this.map,this,color,des,id);
			this.deleteMis();
		}
		//delete all dots and polylines
		this.deleteMis = function(){
			//delete dots
			$.each(this.listOfDots, function(index, value){
				value.remove();
			});
			this.listOfDots.length=0;
			//delete lines
			if(null!=this.polyline){
				this.polyline.remove();
				this.polyline=null;
			}
		}
		//cancel
		this.cancel = function(){
			if(null!=this.polygon){
				(this.polygon.remove());
			}
			this.polygon=null;
			this.deleteMis();
		}
		//setter		
		this.setCurrentDot = function(dot){
			this.currentDot = dot;
		}
		//getter
		this.getListOfDots = function(){
			return this.listOfDots;
		}
		//get plots data
		this.getData = function(){
			if(this.polygon!=null){
				var data ="";
				var paths = this.polygon.getPlots();
				//get paths
				paths.getAt(0).forEach(function(value, index){
					data+=(value.toString());
				});
				return data;
			}else {
				return null;
			}
		}
		//get color
		this.getColor = function(){
				if(this.polygon!=null){
					var color = this.polygon.getColor();
					return color;
				}else {
					return null;
				}
			
		}
	 }
	 
	 /* Child of Pen class
	  * dot class
	  */
	 function Dot(latLng,map,pen){
	 	//property
	 	this.latLng=latLng;
		this.parent = pen;
		
		this.markerObj = new google.maps.Marker({
			      position: this.latLng, 
			      map: map
	 	});	
		
		//closure
		this.addListener = function(){
				var parent=this.parent;
				var thisMarker=this.markerObj;
				var thisDot=this;
				google.maps.event.addListener(thisMarker, 'click', function() { 
				    parent.setCurrentDot(thisDot);
					parent.draw(thisMarker.getPosition());
				});				
		}	
		this.addListener();
		
		//getter 
		this.getLatLng = function(){
				return this.latLng;
		}
			
		this.getMarkerObj = function(){
				return this.markerObj;
		}
		
		this.remove = function(){
			this.markerObj.setMap(null);
		}
	 }
	 
	 /* Child of Pen class
	  * Line class
	  */
	 function Line(listOfDots,map){
	 	this.listOfDots = listOfDots;
		this.map = map;
		this.coords = new Array();
		this.polylineObj=null;
		
		if (this.listOfDots.length > 1) {
			var thisObj=this;
			$.each(this.listOfDots, function(index, value){
				thisObj.coords.push(value.getLatLng());
			});
			
			this.polylineObj  = new google.maps.Polyline({
		      path: this.coords,
		      strokeColor: "#FF0000",
		      strokeOpacity: 1.0,
		      strokeWeight: 2,
			  map: this.map
		    });
	    }
		
		this.remove = function(){
			this.polylineObj.setMap(null);
		}
	 }
	 
	 /* Child of Pen class
	  * polygon class
	  */
	 function Polygon(listOfDots,map,pen,color){
		this.listOfDots = listOfDots;
		this.map = map;
		this.coords = new Array();
		this.parent = pen;
		this.des = 'Hello';
		
		
		
		var thisObj=this;
		$.each(this.listOfDots,function(index,value){
			thisObj.coords.push(value.getLatLng());
		});
		
		this.polygonObj= new google.maps.Polygon({
				    paths: this.coords,
				    strokeColor: "#FF0000",
				    strokeOpacity: 0.8,
				    strokeWeight: 2,
				    fillColor: "#FF0000",
				    fillOpacity: 0.35,
					map:this.map
	  	});
		
		this.remove = function(){
			this.info.remove();
			this.polygonObj.setMap(null);
		}
		
		//getter
		this.getContent = function(){
			return this.des;
		}
		
		
		this.getPolygonObj= function(){
			return this.polygonObj;
		}
		
		this.getListOfDots = function (){
			return this.listOfDots;
		}
		
		this.getPlots = function(){
			return this.polygonObj.getPaths();
		}
		
		this.getColor=function(){
			return 	this.getPolygonObj().fillColor;
		}
		
		//setter
		this.setColor = function(color){
			return 	this.getPolygonObj().setOptions(
							{fillColor:color,
							 strokeColor:color,
							 strokeWeight: 2
							 }
						);
		}
		
		
		this.info = new Info(this,this.map);
		
		//closure		
		this.addListener = function(){
				var info=this.info;
				var thisPolygon=this.polygonObj;
				google.maps.event.addListener(thisPolygon, 'rightclick', function(event) { 					
				    info.show(event.latLng);
				});				
		}	
		this.addListener();
							  
	 }
	 	 
	 /*
	  * Child of Polygon class
	  * Info Class
	  */
	 function Info(polygon,map){
	 	this.parent = polygon;
		this.map = map;
		
		this.color =  document.createElement('input');
		
		this.button = document.createElement('input');
		$(this.button).attr('type','button');
		$(this.button).val("Change Color");
	    var thisOjb=this;
		
		
		//change color action
		this.changeColor= function(){
			thisOjb.parent.setColor($(thisOjb.color).val());
		}
		
		//get content
		this.getContent = function(){
			var content = document.createElement('div');
			
			$(this.color).val(this.parent.getColor());	
			$(this.button).click(function(){
				thisObj.changeColor();
			});
			
			$(content).append(this.color);		
			$(content).append(this.button);
			return content;
		}
		
		thisObj=this;
		this.infoWidObj = new google.maps.InfoWindow({
				    content:thisObj.getContent()
		});
		
		this.show = function(latLng){
			this.infoWidObj.setPosition(latLng);
			this.infoWidObj.open(this.map);
		}
		
		this.remove = function(){
	 		this.infoWidObj.close();
	 	}
		
		
	 }




function Point_string(){
	var Point = P[0];
    P.push(Point);
    console.log(P);
    var c_str="POLYGON((";
    var aa="";
    var lng ="";
    var lat = "";
    for(var i=0; i<P.length;i++){
       lng = P[i].lng();
       lat = P[i].lat();
       aa+=lng+" "+lat +",";
    };

    c_str+=aa.substring(aa,aa.length-1)+"))";
 
 return c_str;
}




  $(document).ready(function(){
    $('#MyButton').click(function(){
        django.jQuery('#id_shape').val(Point_string());
        django.jQuery('#id_shape').text(Point_string());
       });
  });



















	</script>
</head>
<body>
<input type="button" value="Save" id="MyButton" >

<div id="main-map"  style="width:300%; height:600px"></div>	
</body>



	<div id="header">
	   <p>
		<span class="instruction">Demo Instruction:</span>
		Left click on the map to create markers, when last marker meets first marker, it will form a polygon.
		Right click on the polygon to change its color.
		</p>
	</div>
	<div id="main-map">
	</div>
	<div id="side">
		<input id="reset" value="Reset" type="button" class="navi"/>
		<input id="showData"  value="Show Paths (class function) " type="button" class="navi"/>
		<input id="showColor"  value="Show Color (class function) " type="button" class="navi"/>
		<div   id="dataPanel">
		</div>
	</div>
</body>
</html>